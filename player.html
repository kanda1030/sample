<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PSK6V5K');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- Swiper JS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3JQJ50606G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-3JQJ50606G');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MP3プレーヤーアプリ - お気に入りの音楽を聴いたり管理したりできるシンプルなインターフェース">
    <title>MP3プレーヤー</title>
    <style>
        :root {
            /* Netflix inspired color palette */
            --netflix-black: #141414;
            --netflix-dark: #181818;
            --netflix-darker: #0f0f0f;
            --netflix-grey: #808080;
            --netflix-light-grey: #b3b3b3;
            --netflix-lighter-grey: #e5e5e5;
            --netflix-red: #E50914;
            --netflix-red-hover: #f40612;
            --netflix-red-active: #b2070e;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-xxl: 3rem;
            
            /* Layout */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            
            /* Transitions */
            --transition-speed: 0.2s;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #111;
            color: #fff;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Loading Spinner Styles */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        #loading-spinner .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(229, 9, 20, 0.3);
            border-radius: 50%;
            border-top-color: var(--netflix-red);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        header {
            background-color: var(--netflix-darker);
            padding: var(--space-md) var(--space-xl);
            position: static; /* Changed from sticky to static */
            /* top: 0; */ /* Removed */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--netflix-red);
            text-decoration: none;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: var(--space-lg);
        }
        
        nav a {
            color: var(--netflix-light-grey);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color var(--transition-speed);
        }
        
        nav a:hover,
        nav a.active {
            color: var(--netflix-lighter-grey);
        }
        
        main {
            flex: 1;
            padding: var(--space-xl);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .content-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--space-lg);
            text-align: center;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            text-align: center;
            color: var(--netflix-red);
        }
        
        .description {
            font-size: 1rem;
            color: var(--netflix-light-grey);
            margin: var(--space-md) 0 var(--space-xl);
            text-align: center;
        }
        
        /* MP3 List Styles */
        #mp3-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Carousel Styles */
        .carousel-section {
            position: relative;
            margin-bottom: 40px;
            overflow: visible; /* Changed back to visible to allow peeking */
            width: 100%; /* Use full width */
            padding: 0;
        }
        
        .carousel-container {
            position: relative;
            overflow: visible; /* Changed back to visible to allow peeking */
            width: 100%; /* Full width container */
            max-width: none; /* Remove max-width constraint */
            margin: 0 auto;
            padding: 15px 0;
        }
        
        .swiper-wrapper {
            display: flex;
            transition: transform 0.5s ease-in-out;
            padding: 10px 0;
        }
        
        .swiper-slide {
            flex: 0 0 calc(33.33% - 30px); /* Adjusted to show exactly 3 slides with peeking */
            min-width: calc(33.33% - 30px);
            margin-right: 20px; /* Spacing between slides */
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .swiper-slide:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        }
        
        .swiper-slide-duplicate-active,
        .swiper-slide-active {
            z-index: 2;
        }
        
        .swiper-slide-duplicate-next,
        .swiper-slide-next {
            z-index: 1;
        }
        
        .swiper-slide-visible {
            /* For slides currently visible in the viewport */
            opacity: 1;
        }
        
        .swiper-slide-prev {
            /* For the previous slide */
        }
        
        .radius101000 {
            border-radius: 10px;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .carousel-slide:hover {
            transform: scale(1.03);
        }
        
        .carousel-image {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
        }
        
        .carousel-slide:hover .carousel-image {
            filter: brightness(0.85);
        }
        
        .carousel-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
            padding: 0;
            background: linear-gradient(to bottom, 
                rgba(0, 0, 0, 0) 0%,
                rgba(0, 0, 0, 0) 60%, 
                rgba(0, 0, 0, 0.7) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .carousel-content {
            position: absolute;
            left: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            padding: 10px 15px;
        }
        
        .carousel-play-button {
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--netflix-red);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            margin-right: 10px;
            transition: transform 0.3s ease, background-color 0.3s ease;
            flex-shrink: 0;
        }
        
        .carousel-slide:hover .carousel-play-button {
            transform: scale(1.1);
            background-color: white;
        }
        
        .carousel-title {
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            max-width: calc(100% - 50px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .carousel-prev,
        .carousel-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        /* Restore hover effects for navigation buttons */
        .carousel-prev:hover,
        .carousel-next:hover {
            background-color: rgba(229, 9, 20, 0.8);
            transform: translateY(-50%) scale(1.05);
        }
        
        .carousel-prev {
            left: 0;
        }
        
        .carousel-next {
            right: 0;
        }
        
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px; /* Increased spacing from slides */
        }
        
        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .carousel-dot.active {
            background-color: var(--netflix-red);
        }
        
        .mp3-item {
            background-color: #303030;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 15px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .mp3-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .mp3-number-display {
            background-color: #e50914;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .mp3-thumbnail {
            width: 160px;
            height: 160px;
            min-width: 160px;
            background-color: #222;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            margin-right: 15px;
        }
        
        .mp3-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mp3-thumbnail .no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #777;
        }
        
        .mp3-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 0;
        }
        
        .mp3-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .button-container {
            display: flex;
            gap: 10px;
            margin-top: var(--space-xs);
        }
        
        /* Ribbon Effect */
        .ribbon-wrapper {
            width: 120px;
            height: 120px;
            overflow: hidden;
            position: absolute;
            top: -3px;
            right: -3px;
            z-index: 1;
        }
        
        .ribbon {
            font-size: 14px;
            font-weight: bold;
            color: #FFF;
            text-transform: uppercase;
            text-align: center;
            line-height: 25px;
            transform: rotate(45deg);
            width: 150px;
            display: block;
            background: #e50914;
            background: linear-gradient(#e50914 0%, #cb0511 100%);
            box-shadow: 0 3px 10px -5px rgba(0, 0, 0, 1);
            position: absolute;
            top: 25px;
            right: -35px;
        }
        
        .ribbon:before, .ribbon:after {
            content: "";
            position: absolute;
        }
        
        .ribbon:before {
            left: 0;
            top: 100%;
            z-index: -1;
            border-left: 3px solid #8F0808;
            border-right: 3px solid transparent;
            border-bottom: 3px solid transparent;
            border-top: 3px solid #8F0808;
        }
        
        .ribbon:after {
            right: 0;
            top: 100%;
            z-index: -1;
            border-left: 3px solid transparent;
            border-right: 3px solid #8F0808;
            border-bottom: 3px solid transparent;
            border-top: 3px solid #8F0808;
        }
        
        .play-button, .download-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 32px;
            min-width: 140px;
            max-width: 200px;
            margin: 0;
        }
        
        .play-button:hover, .download-button:hover {
            background-color: var(--netflix-red);
        }
        
        .play-button i, .download-button i {
            font-size: 1rem;
            margin-right: 5px;
        }
        
        .no-items {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        
        /* MP3 List styling */
        #mp3-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mp3-item {
            background-color: var(--netflix-dark);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: row;
            padding: var(--space-sm);
            align-items: center;
        }
        
        .mp3-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .mp3-thumbnail {
            width: 160px;
            height: 160px;
            min-width: 160px;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 4px;
            margin-right: 15px;
            position: relative;
        }
        
        .mp3-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mp3-thumbnail.no-image::before {
            content: "\f001";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.2);
        }
        
        .mp3-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .mp3-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mp3-details {
            display: flex;
            justify-content: space-between;
            color: var(--netflix-grey);
            font-size: 0.8rem;
            margin-bottom: var(--space-xs);
        }
        
        .audio-container {
            margin-bottom: var(--space-md);
        }
        
        button {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--netflix-lighter-grey);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-size: 0.9rem;
        }
        
        button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        /* Remove or comment out the 100% width setting for play-button */
        .play-button {
            /* width: 100%; - removed to restore original button size */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background-color: rgba(255, 255, 255, 0.15);
        }
        
        .play-button:hover {
            background-color: var(--netflix-red);
        }
        
        .mp3-buttons {
            display: flex;
            gap: var(--space-sm);
        }
        
        .download-btn, .notion-btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--border-radius-sm);
            flex: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            min-height: 32px;
            min-width: 140px;
            max-width: 200px;
            margin: 0;
        }
        
        /* Play button styling to match download button */
        .play-btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #c41e1e;
            color: white;
            flex: 0.7;
            font-size: 0.9rem;
            min-height: 32px;
            min-width: 140px;
            max-width: 200px;
            margin: 0;
        }
        
        .play-btn i, .download-btn i {
            font-size: 1rem;
            margin-right: 5px;
        }
        
        .action-buttons {
            display: flex;
            margin-top: var(--space-xs);
            gap: var(--space-xs);
            justify-content: flex-start;
        }
        
        .notion-btn.active {
            background-color: var(--netflix-red);
        }
        
        .notion-content {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius-sm);
            padding: var(--space-md);
            margin-top: var(--space-md);
            display: none;
            border-left: 3px solid var(--netflix-red);
        }
        
        .notion-content.active {
            display: block;
        }
        
        .notion-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .notion-url {
            color: var(--netflix-light-grey);
            display: block;
            margin-bottom: var(--space-sm);
            word-break: break-all;
            text-decoration: none;
            transition: color var(--transition-speed);
        }
        
        .notion-url:hover {
            color: var(--netflix-red);
            text-decoration: underline;
        }
        
        .notion-description {
            color: var(--netflix-light-grey);
            font-size: 0.9rem;
        }
        
        /* No MP3 message */
        .no-mp3-message {
            text-align: center;
            padding: var(--space-xxl);
            background-color: var(--netflix-dark);
            border-radius: var(--border-radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: var(--space-xl);
            gap: var(--space-md);
        }
        
        .page-info {
            color: var(--netflix-light-grey);
        }
        
        .pagination button {
            padding: var(--space-sm) var(--space-md);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .pagination button:hover:not([disabled]) {
            background-color: var(--netflix-red);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Footer */
        footer {
            background-color: var(--netflix-darker);
            padding: var(--space-xl) var(--space-xl) var(--space-lg);
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-xl);
        }
        
        .footer-section h3 {
            color: var(--netflix-lighter-grey);
            margin-bottom: var(--space-md);
            font-size: 1.1rem;
        }
        
        .footer-section p {
            color: var(--netflix-grey);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
        }
        
        .footer-section ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-flow: column;
            grid-template-rows: repeat(3, auto);
            gap: var(--space-sm);
        }
        
        /* Add styling for the bullet list in the footer */
        .footer-bullet-list {
            list-style: disc !important;
            display: block !important;
            padding-left: 1.5rem;
        }
        
        .footer-bullet-list li {
            margin-bottom: 0.75rem;
            color: var(--netflix-light-grey);
            font-size: 0.9rem;
        }
        
        .footer-section li {
            margin-bottom: var(--space-sm);
        }
        
        .footer-section a {
            color: var(--netflix-grey);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color var(--transition-speed);
        }
        
        .footer-section a:hover {
            color: var(--netflix-lighter-grey);
            text-decoration: underline;
        }
        
        .copyright {
            text-align: center;
            margin-top: var(--space-xl);
            padding-top: var(--space-md);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--netflix-grey);
            font-size: 0.8rem;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: var(--space-md) var(--space-lg);
            background-color: var(--netflix-dark);
            color: var(--netflix-lighter-grey);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(30px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background-color: #2E7D32;
        }
        
        .notification.error {
            background-color: var(--netflix-red);
        }
        
        .notification.info {
            background-color: #0277BD;
        }
        
        /* Empty message styles */
        .empty-message {
            text-align: center;
            padding: var(--space-xxl);
            background-color: var(--netflix-dark);
            border-radius: var(--border-radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            header, main, footer {
                padding: var(--space-md);
            }
            
            .header-content {
                flex-direction: column;
                gap: var(--space-md);
                align-items: flex-start;
            }
            
            nav ul {
                gap: var(--space-md);
            }
            
            #mp3-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
        }
        
        @media (max-width: 480px) {
            header, main, footer {
                padding: var(--space-sm);
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            #mp3-list {
                grid-template-columns: 1fr;
            }
            
            .mp3-thumbnail {
                height: 150px;
            }
        }
        
        /* Add CSS for disabled download button */
        .download-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: rgba(100, 100, 100, 0.2);
        }
        
        .download-btn.disabled:hover {
            background-color: rgba(100, 100, 100, 0.2);
            transform: none;
        }

        /* Add CSS for disabled download button */
        .download-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: rgba(100, 100, 100, 0.2);
            pointer-events: none;
        }
        
        .download-button.disabled:hover {
            background-color: rgba(100, 100, 100, 0.2);
            transform: none;
        }

        /* Add CSS for the footer heading container */
        .footer-heading-container {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .footer-heading-container h3 {
            margin-bottom: 0;
            margin-right: var(--space-sm);
        }
        
        .notion-note {
            color: var(--netflix-grey);
            font-size: 0.9rem;
        }

        .carousel-slide {
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            border-radius: 10px;
            height: 100%;
        }

        .carousel-link {
            display: block;
            position: relative;
            height: 100%;
            text-decoration: none;
        }

        .carousel-prev,
        .carousel-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        /* Restore hover effects for navigation buttons */
        .carousel-prev:hover,
        .carousel-next:hover {
            background-color: rgba(229, 9, 20, 0.8);
            transform: translateY(-50%) scale(1.05);
        }

        .carousel-prev {
            left: 0;
        }

        .carousel-next {
            right: 0;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PSK6V5K"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Loading Spinner -->
    <div id="loading-spinner">
        <div class="spinner"></div>
        <div>データを読み込み中...</div>
    </div>

    <header>
        <div class="header-content">
            <a href="#" class="logo">VocalSample</a>
        </div>
    </header>

    <!-- Carousel Slider -->
    <div class="carousel-section">
        <div class="carousel-container">
            <div class="swiper-wrapper" id="carouselTrack">
                <!-- Carousel slides will be dynamically generated here -->
            </div>
            <button class="carousel-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="carousel-next">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="carousel-dots" id="carouselDots"></div>
        </div>
    </div>

    <main>
        <div class="content-header">
            <h1>ボーカルコレクション</h1>
        </div>
        <p class="description">まずは聴いてみてください<br>気に入ったならあなただけのものにできますが、もちろん選択はあなた次第です。</p>

        <div id="mp3-list">
            <!-- MP3 items will be inserted here by JavaScript -->
        </div>

        <div class="pagination">
            <button id="prev-page" disabled>前のページ</button>
            <div class="page-info">1 / 1</div>
            <button id="next-page" disabled>次のページ</button>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>MP3データベースについて</h3>
                <ul class="footer-bullet-list">
                    <li>本サイトでは各サンプル、１名様限定となっています。</li>
                    <li>本サイトのサンプルはUdioの有料プランで生成された曲です。</li>
                    <li>ダウンロードしたmp3はご自由にお使いください。</li>
                </ul>
            </div>
            <div class="footer-section" id="notion-links-section">
                <div class="footer-heading-container">
                    <h3>制作過程</h3>
                    <span class="notion-note">※Notionサイトに遷移します</span>
                </div>
                <ul id="notion-links-list">
                    <!-- Notion links will be inserted here by JavaScript -->
                </ul>
            </div>
        </div>
        <div class="copyright">
            🄯 2025 サンプルボーカル | Some Rights Reserved - Copyleft
        </div>
    </footer>

    <script>
        // DB接続検証用のボタンを追加
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.content-header');
            
            /* ヘッダーボタン削除
            // DB情報表示ボタン
            const dbInfoBtn = document.createElement('button');
            dbInfoBtn.textContent = 'DB情報表示';
            dbInfoBtn.style.backgroundColor = 'var(--netflix-dark)';
            dbInfoBtn.style.marginLeft = 'auto';
            
            dbInfoBtn.addEventListener('click', function() {
                showDatabaseInfo();
            });
            
            // DBリセットボタン
            const dbResetBtn = document.createElement('button');
            dbResetBtn.textContent = 'DBリセット';
            dbResetBtn.style.backgroundColor = 'var(--netflix-red)';
            dbResetBtn.style.marginLeft = '10px';
            
            dbResetBtn.addEventListener('click', function() {
                if (confirm('データベースをリセットしますか？すべてのデータが削除されます。')) {
                    resetDatabase();
                }
            });
            
            // 再読み込みボタン
            const reloadBtn = document.createElement('button');
            reloadBtn.textContent = '再読み込み';
            reloadBtn.style.backgroundColor = 'var(--netflix-dark)';
            reloadBtn.style.marginLeft = '10px';
            
            reloadBtn.addEventListener('click', function() {
                loadMp3List();
            });
            
            header.appendChild(dbInfoBtn);
            header.appendChild(dbResetBtn);
            header.appendChild(reloadBtn);
            */
        });

        // データベースをリセット
        function resetDatabase() {
            // データベース接続を閉じる
            if (db) {
                db.close();
                db = null;
            }
            
            // データベースを削除
            const deleteRequest = indexedDB.deleteDatabase(dbName);
            
            deleteRequest.onsuccess = function() {
                console.log('Database deleted successfully');
                showNotification('データベースを削除しました。ページを再読み込みします。', 'success');
                
                // 少し待ってからページを再読み込み
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            };
            
            deleteRequest.onerror = function(event) {
                console.error('Error deleting database:', event.target.error);
                showNotification('データベース削除エラー: ' + event.target.error.message, 'error');
            };
            
            deleteRequest.onblocked = function() {
                console.warn('Database deletion was blocked');
                showNotification('データベース削除がブロックされました。すべてのタブを閉じて再試行してください。', 'error');
            };
        }

        // データベース情報を表示
        function showDatabaseInfo() {
            if (!db) {
                showNotification('データベースが接続されていません', 'error');
                return;
            }
            
            try {
                const transaction = db.transaction(['mp3s'], 'readonly');
                const objectStore = transaction.objectStore('mp3s');
                const request = objectStore.getAll();
                
                request.onsuccess = function() {
                    const items = request.result;
                    console.log('==== データベース内の全アイテム ====');
                    console.log(`合計: ${items.length}件`);
                    
                    items.forEach((item, index) => {
                        console.log(`--- アイテム ${index + 1} (ID: ${item.id}) ---`);
                        console.log('タイトル:', item.title);
                        console.log('日付:', item.date);
                        
                        // MP3データの確認
                        if (item.mp3) {
                            console.log('MP3データ:', '存在します', item.mp3.byteLength || item.mp3.size, 'bytes');
                        } else if (item.audio) {
                            console.log('MP3データ(audio):', '存在します', item.audio.byteLength || item.audio.size, 'bytes');
                        } else if (item.data) {
                            console.log('MP3データ(data):', '存在します', item.data.byteLength || item.data.size, 'bytes');
                        } else {
                            console.log('MP3データ: 見つかりません');
                        }
                        
                        // Notionデータの確認
                        console.log('NotionタイトルとURL:', item.notionTitle, item.notionUrl);
                        
                        // オブジェクトのキーを表示
                        console.log('データキー:', Object.keys(item));
                    });
                    
                    showNotification('データベース情報をコンソールに表示しました', 'info');
                };
                
                request.onerror = function(event) {
                    console.error('データベース情報表示エラー:', event.target.error);
                    showNotification('データベース情報表示エラー', 'error');
                };
            } catch (error) {
                console.error('データベース情報表示中にエラーが発生しました:', error);
                showNotification('データベース情報表示エラー: ' + error.message, 'error');
            }
        }

        // Variables for pagination
        let currentPage = 1;
        const itemsPerPage = 3; // Change from 12 to 3 to match wireframe
        let mp3Items = [];
        let totalItems = 0;
        let sortField = 'number'; // Change from 'date' to 'number' to sort by item number
        let sortDirection = 'asc'; // Change to 'asc' to show numbers in ascending order

        // Reference to page elements
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfo = document.querySelector('.page-info');
        const mp3List = document.getElementById('mp3-list');
        const notionLinksList = document.getElementById('notion-links-list');

        // Event listeners for pagination
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayCurrentPage();
                console.log(`Navigated to page ${currentPage}`); // Add logging for navigation
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < Math.ceil(totalItems / itemsPerPage)) {
                currentPage++;
                displayCurrentPage();
                console.log(`Navigated to page ${currentPage}`); // Add logging for navigation
            }
        });

        // Add loading spinner
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'loading-spinner';
        loadingSpinner.style.display = 'none';
        loadingSpinner.innerHTML = '<div class="spinner"></div><div style="margin-top: 10px;">データを読み込み中...</div>';
        document.querySelector('main').appendChild(loadingSpinner);

        // Connect to the database
        let db;
        let dbName = 'mp3Database';
        let dbVersion = 3; // Use version 3 like index.html
        let dbConnectionRetries = 0;
        const MAX_DB_CONNECTION_RETRIES = 3;

        // Add loading spinner management for both spinners
        function showLoading() {
            // Show dynamic spinner
            loadingSpinner.style.display = 'flex';
            // Show fixed spinner if it exists
            const fixedSpinner = document.getElementById('loading-spinner');
            if (fixedSpinner) {
                fixedSpinner.style.display = 'flex';
            }
        }

        // Function to hide loading spinner
        function hideLoading() {
            // Hide dynamic spinner
            loadingSpinner.style.display = 'none';
            // Hide fixed spinner if it exists
            const fixedSpinner = document.getElementById('loading-spinner');
            if (fixedSpinner) {
                fixedSpinner.style.display = 'none';
            }
        }

        // Ensure loading spinner is hidden as early as possible
        window.addEventListener('load', function() {
            const initialSpinner = document.getElementById('loading-spinner');
            if (initialSpinner) {
                initialSpinner.style.display = 'none';
            }
        });

        // Global timeout as a fallback to hide any spinner
        setTimeout(function() {
            const initialSpinner = document.getElementById('loading-spinner');
            if (initialSpinner) {
                console.log('Force hiding initial loading spinner via global timeout');
                initialSpinner.style.display = 'none';
            }
            
            // Also try to hide the dynamically created spinner
            if (typeof hideLoading === 'function') {
                console.log('Force hiding dynamic spinner via global timeout');
                hideLoading();
            }
        }, 20000); // 20 seconds global timeout

        // Sort items by field
        function sortItems(items, field, direction) {
            return items.sort((a, b) => {
                let valueA = a[field];
                let valueB = b[field];
                
                // Handle undefined values
                if (valueA === undefined) valueA = '';
                if (valueB === undefined) valueB = '';
                
                // For dates, convert to timestamp
                if (field === 'date') {
                    valueA = new Date(valueA).getTime() || 0;
                    valueB = new Date(valueB).getTime() || 0;
                }
                
                // Sort direction
                const directionFactor = direction === 'asc' ? 1 : -1;
                
                // String comparison for strings
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    return directionFactor * valueA.localeCompare(valueB);
                }
                
                // Numeric comparison for numbers
                return directionFactor * (valueA - valueB);
            });
        }

        // Display Notion items in footer
        function displayNotionItems(items) {
            if (!notionLinksList) return;
            
            console.log('Displaying Notion links in footer');
            
            // Filter items that have Notion data
            const notionItems = items.filter(item => 
                item.notionUrl || 
                item.notionTitle || 
                (item.title && item.title.startsWith('Notion:'))
            );
            
            console.log(`Found ${notionItems.length} items with Notion data`);
            
            if (notionItems.length === 0) {
                notionLinksList.innerHTML = '<li>登録されたNotionリンクがありません</li>';
                return;
            }
            
            notionLinksList.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            // Take only the first 5 items to keep the footer clean
            notionItems.slice(0, 5).forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = item.notionUrl || '#';
                a.target = '_blank';
                
                // Get title (prefer notionTitle, fallback to title without "Notion:" prefix)
                let displayTitle = item.notionTitle;
                if (!displayTitle && item.title && item.title.startsWith('Notion:')) {
                    displayTitle = item.title.substring(7).trim();
                }
                
                a.textContent = displayTitle || item.title || 'Notionリンク';
                li.appendChild(a);
                fragment.appendChild(li);
            });
            
            if (notionItems.length > 5) {
                const li = document.createElement('li');
                li.textContent = `...他 ${notionItems.length - 5} 件のリンク`;
                fragment.appendChild(li);
            }
            
            notionLinksList.appendChild(fragment);
        }

        // Load MP3 list from database
        function loadMp3List() {
            if (!db) {
                console.error('データベースが接続されていません');
                showNotification('データベースが接続されていません', 'error');
                hideLoading(); // Ensure spinner is hidden
                return;
            }

            // Check if mp3s object store exists
            if (!db.objectStoreNames.contains('mp3s')) {
                console.error('mp3sオブジェクトストアが存在しません');
                showNotification('mp3sオブジェクトストアが存在しません。index.htmlでデータベースを作成してください。', 'error');
                
                mp3List.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>データベースが空です</h3>
                        <p>MP3ファイルを追加するには、<a href="index.html">アップロードページ</a>を使用してください。</p>
                    </div>
                `;
                hideLoading(); // Ensure spinner is hidden
                return;
            }

            console.log('MP3リストを読み込み中...');
            showNotification('データベースからMP3リストを読み込み中...', 'info');

            try {
                const transaction = db.transaction(['mp3s'], 'readonly');
                const objectStore = transaction.objectStore('mp3s');
                
                // Add transaction error handling
                transaction.onerror = function(event) {
                    console.error('トランザクションエラー:', event.target.error);
                    showNotification('データベーストランザクションエラー', 'error');
                    hideLoading(); // Ensure spinner is hidden
                };
                
                // Count total items
                const countRequest = objectStore.count();
                
                countRequest.onsuccess = function() {
                    totalItems = countRequest.result;
                    console.log(`データベース内のアイテム数: ${totalItems}件`);
                    
                    if (totalItems === 0) {
                        mp3List.innerHTML = `
                            <div class="empty-message">
                                <i class="fas fa-music" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h3>データベースが空です</h3>
                                <p>MP3ファイルを追加するには、<a href="index.html">アップロードページ</a>を使用してください。</p>
                            </div>
                        `;
                        hideLoading(); // Ensure spinner is hidden
                        return;
                    }
                    
                    // Get all items
                    const request = objectStore.getAll();
                    
                    request.onsuccess = function(event) {
                        try { // Add try-catch to handle any errors in processing
                            const items = event.target.result;
                            console.log(`${items.length}件のMP3アイテムを取得しました`);
                            
                            // Make sure each item has a number property for sorting
                            items.forEach((item, index) => {
                                // If number property is missing, assign one based on index
                                if (!item.number) {
                                    item.number = index + 1;
                                } else if (typeof item.number === 'string') {
                                    // Convert to number if it's a string
                                    item.number = parseInt(item.number, 10) || index + 1;
                                }
                            });
                            
                            // Diagnostic information about audio data
                            const audioDataStats = {
                                total: items.length,
                                hasAudioData: 0,
                                noAudioData: 0,
                                audioDataTypes: {},
                                typicalAudioDataSize: null
                            };
                            
                            // Inspect some items to understand data structure
                            items.slice(0, 5).forEach((item, index) => {
                                console.log(`アイテム ${index + 1}/${Math.min(5, items.length)} の詳細:`, {
                                    id: item.id,
                                    title: item.title,
                                    date: item.date ? new Date(item.date).toLocaleString() : 'なし',
                                    audioDataPresent: !!item.audioData || !!item.audio,
                                    audioDataType: item.audioData ? typeof item.audioData : (item.audio ? typeof item.audio : 'なし'),
                                    audioDataProperties: item.audioData ? Object.keys(item.audioData) : (item.audio ? Object.keys(item.audio) : [])
                                });
                            });
                            
                            // Check audio data availability across all items
                            items.forEach(item => {
                                const hasData = !!getRecoverableAudioData(item);
                                if (hasData) {
                                    audioDataStats.hasAudioData++;
                                    
                                    // Analyze audio data type
                                    const audioData = getRecoverableAudioData(item);
                                    const dataType = getAudioDataType(audioData);
                                    audioDataStats.audioDataTypes[dataType] = (audioDataStats.audioDataTypes[dataType] || 0) + 1;
                                    
                                    // Get typical size
                                    if (audioDataStats.typicalAudioDataSize === null && audioData) {
                                        if (audioData instanceof ArrayBuffer) {
                                            audioDataStats.typicalAudioDataSize = audioData.byteLength;
                                        } else if (audioData.buffer instanceof ArrayBuffer) {
                                            audioDataStats.typicalAudioDataSize = audioData.buffer.byteLength;
                                        } else if (typeof audioData === 'object') {
                                            audioDataStats.typicalAudioDataSize = 'オブジェクト';
                                        }
                                    }
                                } else {
                                    audioDataStats.noAudioData++;
                                }
                            });
                            
                            console.log('オーディオデータ統計:', audioDataStats);

                            // Add image data statistics to the loadMp3List function
                            const imageDataStats = {
                                total: items.length,
                                hasImageData: 0,
                                noImageData: 0,
                                imageDataTypes: {}
                            };

                            // Check image data availability across all items
                            items.forEach(item => {
                                const hasImage = !!getRecoverableImageData(item);
                                if (hasImage) {
                                    imageDataStats.hasImageData++;
                                    
                                    // Analyze image data type
                                    const imageData = getRecoverableImageData(item);
                                    const dataType = imageData.type || 'unknown';
                                    imageDataStats.imageDataTypes[dataType] = (imageDataStats.imageDataTypes[dataType] || 0) + 1;
                                } else {
                                    imageDataStats.noImageData++;
                                }
                            });

                            console.log('画像データ統計:', imageDataStats);
                            
                            // Sort items by the specified field and direction
                            mp3Items = sortItems(items, sortField, sortDirection);
                            
                            // Store all items for Notion display in footer
                            const allItems = [...mp3Items];

                            // Filter out Notion items for display in the MP3 collection
                            mp3Items = mp3Items.filter(item => !(item.title && item.title.startsWith('Notion:')));
                            console.log(`表示可能なMP3アイテム: ${mp3Items.length}件 (${allItems.length - mp3Items.length}件のNotionアイテムを除外)`);

                            // Reset current page to 1 when loading new data
                            currentPage = 1;
                            console.log(`Pagination reset: page ${currentPage}, items per page: ${itemsPerPage}, total items: ${mp3Items.length}`);
                            
                            // Display items for the current page
                            displayCurrentPage();

                            // Display Notion links in footer using all items (including Notion items)
                            displayNotionItems(allItems);
                            
                            // Hide loading spinner
                            hideLoading();
                            
                            // Update the notification to include image data status
                            if (audioDataStats.noAudioData > 0 || imageDataStats.noImageData > 0) {
                                let message = "";
                                
                                if (audioDataStats.noAudioData > 0) {
                                    message += `${audioDataStats.noAudioData}件のMP3データが読み込めませんでした`;
                                }
                                
                                if (imageDataStats.noImageData > 0 && imageDataStats.hasImageData > 0) {
                                    if (message) message += "、";
                                    message += `${imageDataStats.noImageData}件の画像が表示できません`;
                                }
                                
                                showNotification(message, 'warning');
                            } else {
                                showNotification(`${items.length}件のMP3データを読み込みました`, 'success');
                            }
                        } catch (error) {
                            console.error('MP3データの処理中にエラーが発生しました:', error);
                            showNotification('MP3データの処理中にエラーが発生しました: ' + error.message, 'error');
                            hideLoading(); // Ensure spinner is hidden even if processing fails
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error('MP3データの取得エラー:', event.target.error);
                        showNotification('MP3データの取得に失敗しました', 'error');
                        
                        // Hide loading spinner
                        hideLoading();
                    };
                };
                
                countRequest.onerror = function(event) {
                    console.error('アイテム数の取得エラー:', event.target.error);
                    showNotification('データベース内のアイテム数の取得に失敗しました', 'error');
                    
                    // Hide loading spinner
                    hideLoading();
                };
            } catch (error) {
                console.error('MP3リスト読み込みエラー:', error);
                showNotification(`MP3リスト読み込みエラー: ${error.message}`, 'error');
                
                // Hide loading spinner
                hideLoading();
            }
            
            // Add a global timeout to ensure the spinner is hidden
            setTimeout(() => {
                hideLoading();
            }, 15000); // 15 seconds timeout
        }

        // Determine the type of audio data
        function getAudioDataType(audioData) {
            if (!audioData) return 'なし';
            if (audioData instanceof ArrayBuffer) return 'ArrayBuffer';
            if (audioData instanceof Uint8Array) return 'Uint8Array';
            if (audioData.buffer instanceof ArrayBuffer) return 'TypedArray';
            if (typeof audioData === 'object') return 'Object';
            return typeof audioData;
        }

        // MP3データの回復試行関数
        function getRecoverableAudioData(item) {
            // 標準のプロパティをまず確認
            if (item.audioData && (
                item.audioData instanceof ArrayBuffer || 
                item.audioData instanceof Uint8Array ||
                (item.audioData.buffer && item.audioData.buffer instanceof ArrayBuffer)
            )) {
                return item.audioData;
            }
            
            // audioプロパティを確認
            if (item.audio && (
                item.audio instanceof ArrayBuffer || 
                item.audio instanceof Uint8Array ||
                (item.audio.buffer && item.audio.buffer instanceof ArrayBuffer)
            )) {
                return item.audio;
            }
            
            // データの形式が異なる可能性がある場合の回復試行
            // 1. オブジェクト内の大きなバイナリプロパティを探す
            if (item.audioData && typeof item.audioData === 'object') {
                for (const key in item.audioData) {
                    const prop = item.audioData[key];
                    if (prop instanceof ArrayBuffer || 
                        prop instanceof Uint8Array ||
                        (prop && prop.buffer && prop.buffer instanceof ArrayBuffer)) {
                        console.log(`回復: audioData.${key}から有効なバイナリデータを見つけました`);
                        return prop;
                    }
                }
            }
            
            // 2. audioプロパティがオブジェクトの場合も同様に確認
            if (item.audio && typeof item.audio === 'object') {
                for (const key in item.audio) {
                    const prop = item.audio[key];
                    if (prop instanceof ArrayBuffer || 
                        prop instanceof Uint8Array ||
                        (prop && prop.buffer && prop.buffer instanceof ArrayBuffer)) {
                        console.log(`回復: audio.${key}から有効なバイナリデータを見つけました`);
                        return prop;
                    }
                }
            }
            
            // 3. アイテム自体の中から大きなバイナリプロパティを探す
            for (const key in item) {
                if (key === 'audioData' || key === 'audio') continue; // 既に確認済み
                
                const prop = item[key];
                if (prop instanceof ArrayBuffer || 
                    prop instanceof Uint8Array ||
                    (prop && prop.buffer && prop.buffer instanceof ArrayBuffer)) {
                    console.log(`回復: ${key}から有効なバイナリデータを見つけました`);
                    return prop;
                }
            }
            
            console.warn(`ID ${item.id}のアイテムからオーディオデータを回復できませんでした`);
            return null;
        }

        // Get recoverable image data
        function getRecoverableImageData(item) {
            // Check standard image properties
            if (item.image && (
                item.image instanceof Blob || 
                item.image instanceof File ||
                typeof item.image === 'object'
            )) {
                return item.image;
            }
            
            // Check thumbnail property
            if (item.thumbnail && (
                item.thumbnail instanceof Blob || 
                item.thumbnail instanceof File ||
                typeof item.thumbnail === 'object'
            )) {
                return item.thumbnail;
            }
            
            // Check imageData property
            if (item.imageData && (
                item.imageData instanceof Blob || 
                item.imageData instanceof File ||
                typeof item.imageData === 'object'
            )) {
                return item.imageData;
            }
            
            // Look for binary data that might be images
            for (const key in item) {
                if (key === 'image' || key === 'thumbnail' || key === 'imageData' || 
                    key === 'audio' || key === 'audioData' || key === 'mp3') continue; // Skip already checked or audio data
                
                const prop = item[key];
                if (prop instanceof Blob || prop instanceof File) {
                    // Check if it's likely an image by mime type
                    if (prop.type && prop.type.startsWith('image/')) {
                        console.log(`回復: ${key}から有効な画像データを見つけました`);
                        return prop;
                    }
                }
                
                // Check for ArrayBuffer or typed arrays that might be images
                if (prop instanceof ArrayBuffer || 
                    (prop && prop.buffer instanceof ArrayBuffer) ||
                    (typeof prop === 'object' && prop !== null)) {
                    
                    // Skip if it looks like audio data (typically larger)
                    const isLikelyAudio = (
                        (prop instanceof ArrayBuffer && prop.byteLength > 100000) ||
                        (prop.buffer instanceof ArrayBuffer && prop.buffer.byteLength > 100000)
                    );
                    
                    if (!isLikelyAudio && key.toLowerCase().includes('image')) {
                        console.log(`回復: ${key}からバイナリ画像データを見つけました`);
                        try {
                            // Try to convert ArrayBuffer to Blob
                            const blob = new Blob([prop], { type: 'image/jpeg' });
                            return blob;
                        } catch (error) {
                            console.warn(`${key}からBlobへの変換に失敗:`, error);
                        }
                    }
                }
            }
            
            return null;
        }

        // Display MP3 items
        function displayMp3Items(items) {
            const mp3List = document.getElementById('mp3-list');
            mp3List.innerHTML = '';
            
            if (items.length === 0) {
                mp3List.innerHTML = '<div class="no-items">MP3ファイルが見つかりません</div>';
                return;
            }

            // Get the downloaded items from localStorage
            const downloadedItems = JSON.parse(localStorage.getItem('downloadedMp3s') || '{}');

            // Remove the redundant pagination logic - we're already receiving the correct items for the current page
            items.forEach((item, index) => {
                const mp3Item = document.createElement('div');
                mp3Item.className = 'mp3-item';
                
                const numberDisplay = document.createElement('div');
                numberDisplay.className = 'mp3-number-display';
                numberDisplay.textContent = item.number || index + 1;
                
                const thumbnailContainer = document.createElement('div');
                thumbnailContainer.className = 'mp3-thumbnail';
                
                // Add ribbon wrapper and ribbon
                const ribbonWrapper = document.createElement('div');
                ribbonWrapper.className = 'ribbon-wrapper';
                const ribbon = document.createElement('div');
                ribbon.className = 'ribbon';
                ribbon.textContent = '先着一名限定';
                ribbonWrapper.appendChild(ribbon);
                thumbnailContainer.appendChild(ribbonWrapper);
                
                // Try to get image data using the recovery function
                const imageData = getRecoverableImageData(item);
                if (imageData) {
                    const img = document.createElement('img');
                    try {
                        // Handle different types of image data
                        if (imageData instanceof Blob) {
                            img.src = URL.createObjectURL(imageData);
                        } else if (imageData.data) {
                            img.src = URL.createObjectURL(new Blob([imageData.data], { type: imageData.type || 'image/jpeg' }));
                        } else {
                            // Try to create a blob from binary data
                            img.src = URL.createObjectURL(new Blob([imageData], { type: 'image/jpeg' }));
                        }
                        thumbnailContainer.appendChild(img);
                    } catch (error) {
                        console.warn('Image data conversion error:', error);
                        thumbnailContainer.innerHTML += '<div class="no-image">No Image</div>';
                    }
                } else {
                    thumbnailContainer.innerHTML += '<div class="no-image">No Image</div>';
                }
                
                const contentContainer = document.createElement('div');
                contentContainer.className = 'mp3-content';
                
                const title = document.createElement('div');
                title.className = 'mp3-title';
                title.textContent = item.title || 'Untitled';
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                // Create audio element
                const audio = document.createElement('audio');
                audio.style.display = 'none';
                
                // Try to get audio data using the recovery function
                const audioData = getRecoverableAudioData(item);
                if (audioData) {
                    try {
                        // Handle different types of audio data
                        if (audioData instanceof Blob) {
                            audio.src = URL.createObjectURL(audioData);
                        } else if (audioData.data) {
                            audio.src = URL.createObjectURL(new Blob([audioData.data], { type: audioData.type || 'audio/mpeg' }));
                        } else {
                            // Try to create a blob from binary data
                            audio.src = URL.createObjectURL(new Blob([audioData], { type: 'audio/mpeg' }));
                        }
                    } catch (error) {
                        console.warn('Audio data conversion error:', error);
                    }
                }
                
                // Create play button
                const playButton = document.createElement('button');
                playButton.className = 'play-button';
                playButton.innerHTML = '<i class="fas fa-play"></i> 再生';
                playButton.onclick = function() {
                    // Stop all other playing audio
                    document.querySelectorAll('audio').forEach(a => {
                        if (a !== audio) {
                            a.pause();
                            a.currentTime = 0;
                        }
                    });
                    
                    // Reset all play buttons
                    document.querySelectorAll('.play-button').forEach(btn => {
                        if (btn !== playButton) {
                            btn.innerHTML = '<i class="fas fa-play"></i> 再生';
                        }
                    });
                    
                    if (audio.paused) {
                        audio.play();
                        playButton.innerHTML = '<i class="fas fa-pause"></i> 停止';
                    } else {
                        audio.pause();
                        playButton.innerHTML = '<i class="fas fa-play"></i> 再生';
                    }
                };
                
                // Create download button
                const downloadButton = document.createElement('button');
                downloadButton.className = 'download-button';
                downloadButton.innerHTML = '<i class="fas fa-download"></i> ダウンロード';
                
                // Check if this item has been downloaded before
                const isDownloaded = downloadedItems[item.id];
                if (isDownloaded) {
                    // Disable the button if already downloaded
                    downloadButton.classList.add('disabled');
                    downloadButton.disabled = true;
                    downloadButton.innerHTML = '<i class="fas fa-check"></i> ダウンロード済み';
                    downloadButton.style.pointerEvents = 'none'; // Ensure no mouse events are processed
                } else {
                    // Enable download with tracking
                    downloadButton.onclick = function() {
                        if (audioData) {
                            try {
                                let blob;
                                if (audioData instanceof Blob) {
                                    blob = audioData;
                                } else if (audioData.data) {
                                    blob = new Blob([audioData.data], { type: audioData.type || 'audio/mpeg' });
                                } else {
                                    blob = new Blob([audioData], { type: 'audio/mpeg' });
                                }
                                
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `${item.title || 'audio'}.mp3`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                
                                // Mark this item as downloaded
                                downloadedItems[item.id] = true;
                                localStorage.setItem('downloadedMp3s', JSON.stringify(downloadedItems));
                                
                                // Update button state
                                downloadButton.classList.add('disabled');
                                downloadButton.disabled = true;
                                downloadButton.innerHTML = '<i class="fas fa-check"></i> ダウンロード済み';
                                downloadButton.style.pointerEvents = 'none'; // Ensure no mouse events are processed
                                downloadButton.onclick = null;
                                
                                showNotification('ダウンロードが完了しました', 'success');
                            } catch (error) {
                                console.warn('Download error:', error);
                                showNotification('ダウンロードエラー: ' + error.message, 'error');
                            }
                        } else {
                            showNotification('オーディオデータが見つかりません', 'error');
                        }
                    };
                }
                
                buttonContainer.appendChild(playButton);
                buttonContainer.appendChild(downloadButton);
                
                contentContainer.appendChild(title);
                contentContainer.appendChild(buttonContainer);
                contentContainer.appendChild(audio);
                
                mp3Item.appendChild(numberDisplay);
                mp3Item.appendChild(thumbnailContainer);
                mp3Item.appendChild(contentContainer);
                
                mp3List.appendChild(mp3Item);
            });
            
            // Update pagination controls based on total items, not just the current page items
            updatePagination(totalItems);
        }

        // Display current page of MP3 items
        function displayCurrentPage() {
            console.log(`Displaying page ${currentPage} (items ${(currentPage - 1) * itemsPerPage + 1} to ${Math.min(currentPage * itemsPerPage, mp3Items.length)})`);
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, mp3Items.length);
            const itemsToDisplay = mp3Items.slice(startIndex, endIndex);
            
            displayMp3Items(itemsToDisplay);
            
            // Update pagination info directly to ensure it's always in sync
            updatePagination(mp3Items.length);
        }

        // Update pagination information
        function updatePagination(itemCount) {
            // Always use the total number of MP3 items for consistent pagination
            const count = mp3Items ? mp3Items.length : 0;
            
            const totalPages = Math.ceil(count / itemsPerPage) || 1;
            pageInfo.textContent = `${currentPage} / ${totalPages}`;
            
            // ページ数が変わった場合、currentPageを調整
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            
            // ボタンの有効/無効を設定
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            console.log(`Pagination updated: page ${currentPage}/${totalPages}, total items: ${count}`);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes || isNaN(bytes)) return 'N/A';
            
            const sizes = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < sizes.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${sizes[unitIndex]}`;
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'N/A'; // Invalid date
                
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('ja-JP', options);
            } catch (e) {
                console.error('Invalid date:', dateString);
                return 'N/A';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            console.log(`Notification (${type}):`, message);
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Trigger reflow to ensure transition works
            notification.offsetHeight;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ページ読み込み時の初期化処理
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM読み込み完了 - 初期化処理を開始します');
            
            // アプリケーションの初期化
            initApp();
        });

        // アプリケーションの初期化
        function initApp() {
            // ストレージ使用状況を確認
            checkStorage();
            
            // ローディングスピナーを表示
            showLoading();
            
            // データベースに接続してデータを読み込む
            connectToDatabase()
                .then(() => {
                    console.log('データベース接続成功 - MP3リストを読み込みます');
                    loadMp3List();
                })
                .catch(error => {
                    console.error('データベース接続エラー:', error);
                    hideLoading();
                    showNotification(`データベース接続エラー: ${error.message}`, 'error');
                    
                    // エラーメッセージを表示
                    mp3List.innerHTML = `
                        <div class="empty-message">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--netflix-red); margin-bottom: 1rem;"></i>
                            <h3>データベース接続エラー</h3>
                            <p>${error.message}</p>
                            <button id="retry-connection" style="margin-top: 1rem;">再接続を試みる</button>
                        </div>
                    `;
                    
                    // 再接続ボタンのイベントリスナーを設定
                    const retryBtn = document.getElementById('retry-connection');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => {
                            dbConnectionRetries = 0;
                            dbVersion = 3; // バージョンをリセット
                            showLoading();
                            connectToDatabase()
                                .then(() => {
                                    console.log('再接続成功');
                                    showNotification('データベースに再接続しました', 'success');
                                    loadMp3List();
                                })
                                .catch(error => {
                                    hideLoading();
                                    console.error('再接続エラー:', error);
                                    showNotification(`再接続エラー: ${error.message}`, 'error');
                                });
                        });
                    }
                });
        }

        // IndexedDBの接続時にストレージの確認を行う関数
        function checkStorage() {
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    console.log('ストレージ使用状況:');
                    console.log(`使用量: ${formatFileSize(estimate.usage)}`);
                    console.log(`クォータ: ${formatFileSize(estimate.quota)}`);
                    console.log(`使用率: ${(estimate.usage / estimate.quota * 100).toFixed(2)}%`);
                    
                    // ストレージの使用率が高い場合は警告
                    if (estimate.usage / estimate.quota > 0.8) {
                        showNotification(`ストレージの使用率が高いです (${(estimate.usage / estimate.quota * 100).toFixed(2)}%)`, 'warning');
                    }
                });
            } else {
                console.log('Storage API not supported in this browser');
            }
        }

        // データベース接続を試みる
        function connectToDatabase() {
            console.log(`データベース接続試行: ${dbName} v${dbVersion} (${dbConnectionRetries + 1}/${MAX_DB_CONNECTION_RETRIES})`);
            
            showLoading();
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = function(event) {
                    console.error('データベース接続エラー:', event.target.error);
                    
                    // VersionErrorの場合は別のバージョンで試行
                    if (event.target.error.name === 'VersionError') {
                        console.log('バージョンエラー - 別のバージョンで試行します');
                        
                        if (dbVersion === 3) {
                            dbVersion = 2;
                        } else if (dbVersion === 2) {
                            dbVersion = 1;
                        } else {
                            dbVersion = 3;
                        }
                        
                        dbConnectionRetries++;
                        
                        if (dbConnectionRetries < MAX_DB_CONNECTION_RETRIES) {
                            setTimeout(() => {
                                connectToDatabase().then(resolve).catch(reject);
                            }, 500);
                        } else {
                            hideLoading();
                            reject(new Error('互換性のあるデータベースバージョンが見つかりませんでした'));
                        }
                    } else {
                        hideLoading();
                        reject(event.target.error);
                    }
                };
                
                request.onblocked = function(event) {
                    console.warn('データベース接続がブロックされています');
                    hideLoading();
                    showNotification('データベース接続がブロックされています。他のタブを閉じて再試行してください。', 'warning');
                    reject(new Error('データベース接続がブロックされています'));
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log(`データベース '${dbName}' (v${db.version}) に接続しました`);
                    
                    // データベース構造の検証
                    validateDatabaseStructure()
                        .then(() => {
                            console.log('データベース構造の検証が完了しました');
                            hideLoading();
                            
                            // バージョン変更を監視
                            db.onversionchange = function() {
                                db.close();
                                console.log('データベースが別のタブで更新されました');
                                showNotification('データベースが更新されました。ページを再読み込みしてください。', 'info');
                            };
                            
                            resolve(db);
                        })
                        .catch(error => {
                            console.error('データベース構造検証エラー:', error);
                            hideLoading();
                            reject(error);
                        });
                };
                
                request.onupgradeneeded = function(event) {
                    console.log(`データベースのアップグレード: v${event.oldVersion} -> v${event.newVersion}`);
                    db = event.target.result;
                    
                    // mp3sオブジェクトストアが存在しない場合は作成
                    if (!db.objectStoreNames.contains('mp3s')) {
                        console.log('mp3sオブジェクトストアを作成します');
                        const objectStore = db.createObjectStore('mp3s', { keyPath: 'id', autoIncrement: true });
                        
                        // 必要なインデックスを作成
                        objectStore.createIndex('title', 'title', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });
                        objectStore.createIndex('number', 'number', { unique: false });
                        objectStore.createIndex('notionTitle', 'notionTitle', { unique: false });
                        objectStore.createIndex('notionUrl', 'notionUrl', { unique: false });
                        objectStore.createIndex('image', 'image', { unique: false });
                        objectStore.createIndex('thumbnail', 'thumbnail', { unique: false });
                        console.log('mp3sオブジェクトストアとインデックスを作成しました');
                    } else {
                        console.log('mp3sオブジェクトストアは既に存在します');
                        
                        // 既存のオブジェクトストアに対するアップグレード処理
                        const objectStore = event.target.transaction.objectStore('mp3s');
                        
                        // 必要なインデックスの確認と追加
                        ['title', 'date', 'number', 'notionTitle', 'notionUrl', 'image', 'thumbnail'].forEach(indexName => {
                            if (!objectStore.indexNames.contains(indexName)) {
                                console.log(`${indexName}インデックスを追加します`);
                                objectStore.createIndex(indexName, indexName, { unique: false });
                            }
                        });
                    }
                };
            });
        }

        // データベース構造を検証
        function validateDatabaseStructure() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('データベースが接続されていません'));
                    return;
                }
                
                // mp3sオブジェクトストアが存在するか確認
                if (!db.objectStoreNames.contains('mp3s')) {
                    reject(new Error('mp3sオブジェクトストアが存在しません'));
                    return;
                }
                
                try {
                    const transaction = db.transaction(['mp3s'], 'readonly');
                    const objectStore = transaction.objectStore('mp3s');
                    
                    // インデックスの確認
                    const indexNames = Array.from(objectStore.indexNames);
                    console.log('利用可能なインデックス:', indexNames);
                    
                    // 必要なインデックスの確認
                    const requiredIndices = ['title', 'date'];
                    const missingIndices = requiredIndices.filter(index => !indexNames.includes(index));
                    
                    if (missingIndices.length > 0) {
                        console.warn('一部の重要なインデックスが見つかりません:', missingIndices);
                        showNotification('データベースの一部のインデックスが見つかりません。互換性モードで動作します。', 'warning');
                    }
                    
                    // データベース内のアイテム数を確認
                    const countRequest = objectStore.count();
                    
                    countRequest.onsuccess = function() {
                        const itemCount = countRequest.result;
                        console.log(`データベース内のアイテム数: ${itemCount}件`);
                        resolve();
                    };
                    
                    countRequest.onerror = function(event) {
                        console.error('アイテム数の取得エラー:', event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error('データベース構造検証中にエラーが発生しました:', error);
                    reject(error);
                }
            });
        }
        
        // Function to initialize carousel with MP3 items
        function initCarousel() {
            console.log('Initializing carousel');
            
            return function updateCarousel() {
                console.log('Updating carousel with MP3 items');
                
                const carouselTrack = document.getElementById('carouselTrack');
                const carouselDots = document.getElementById('carouselDots');
                
                if (!carouselTrack || !mp3Items || !mp3Items.length) {
                    console.log('Cannot update carousel: missing elements or items');
                    return;
                }
                
                // Clear existing content
                carouselTrack.innerHTML = '';
                if (carouselDots) carouselDots.innerHTML = '';
                
                // Get featured items for carousel (up to 8)
                const featuredItems = mp3Items.slice(0, 8);

                // Create duplicate items for infinite scroll effect
                const itemsWithDuplicates = [...featuredItems, ...featuredItems, ...featuredItems];
                
                // Create slides for each featured item (original + duplicates for infinite effect)
                itemsWithDuplicates.forEach((item, index) => {
                    // Create slide element
                    const slide = document.createElement('div');
                    slide.className = 'carousel-slide swiper-slide';
                    
                    // Add swiper-specific classes
                    const originalIndex = index % featuredItems.length;
                    slide.dataset.swiperSlideIndex = originalIndex;
                    slide.setAttribute('role', 'group');
                    slide.setAttribute('aria-label', `${originalIndex + 1} / ${featuredItems.length}`);
                    
                    // Set duplicate class if needed
                    if (index < featuredItems.length || index >= featuredItems.length * 2) {
                        slide.classList.add('swiper-slide-duplicate');
                    }
                    
                    // Get image data for the slide
                    const imageData = getRecoverableImageData(item);
                    const imageUrl = imageData ? URL.createObjectURL(
                        imageData instanceof Blob ? imageData : 
                        new Blob([imageData], { type: 'image/jpeg' })
                    ) : '';

                    // Create audio element directly in the slide
                    const audio = document.createElement('audio');
                    audio.style.display = 'none';
                    
                    // Get audio data for direct playback
                    const audioData = getRecoverableAudioData(item);
                    if (audioData) {
                        try {
                            // Handle different types of audio data
                            if (audioData instanceof Blob) {
                                audio.src = URL.createObjectURL(audioData);
                            } else if (audioData.data) {
                                audio.src = URL.createObjectURL(new Blob([audioData.data], { type: audioData.type || 'audio/mpeg' }));
                            } else {
                                // Try to create a blob from binary data
                                audio.src = URL.createObjectURL(new Blob([audioData], { type: 'audio/mpeg' }));
                            }
                        } catch (error) {
                            console.warn('Carousel audio data conversion error:', error);
                        }
                    }
                    
                    // Create slide content with anchor tag like reference
                    slide.innerHTML = `
                        <a href="#" class="carousel-link">
                            <img class="carousel-image fade-in radius101000 lazyloaded" 
                                data-src="${imageUrl || 'https://via.placeholder.com/380x240/333/666?text=No+Image'}" 
                                src="${imageUrl || 'https://via.placeholder.com/380x240/333/666?text=No+Image'}" 
                                alt="${item.title || 'Untitled'}" 
                                decoding="async" />
                            <div class="carousel-overlay">
                                <div class="carousel-content">
                                    <button class="carousel-play-button">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <div class="carousel-title">${item.title || 'Untitled'}</div>
                                </div>
                            </div>
                        </a>
                    `;
                    
                    // Append the audio element to the slide
                    slide.appendChild(audio);
                    
                    // Get the play button after the slide content is set
                    const playButton = slide.querySelector('.carousel-play-button');
                    
                    // Add click event to play audio directly
                    playButton.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent slide click event from triggering
                        
                        // Stop all other playing audio
                        document.querySelectorAll('audio').forEach(a => {
                            if (a !== audio) {
                                a.pause();
                                a.currentTime = 0;
                            }
                        });
                        
                        // Reset all play buttons in carousel
                        document.querySelectorAll('.carousel-play-button').forEach(btn => {
                            if (btn !== playButton) {
                                btn.innerHTML = '<i class="fas fa-play"></i>';
                            }
                        });
                        
                        // Play or pause the audio
                        if (audio.paused) {
                            audio.play();
                            playButton.innerHTML = '<i class="fas fa-pause"></i>';
                        } else {
                            audio.pause();
                            playButton.innerHTML = '<i class="fas fa-play"></i>';
                        }
                    });
                    
                    // Add slide to track
                    carouselTrack.appendChild(slide);
                    
                    // Only create dots for original items (not duplicates)
                    if (index >= featuredItems.length && index < featuredItems.length * 2 && carouselDots) {
                        const dot = document.createElement('div');
                        dot.className = 'carousel-dot' + (originalIndex === 0 ? ' active' : '');
                        dot.dataset.index = originalIndex;
                        dot.addEventListener('click', () => {
                            goToSlide(originalIndex);
                        });
                        carouselDots.appendChild(dot);
                    }
                });
                
                // Initialize carousel variables
                let currentIndex = 0;
                let slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                const slidesPerView = getSlidesPerView();
                const maxIndex = Math.max(0, featuredItems.length - slidesPerView);
                
                // Update carousel controls
                const prevButton = document.querySelector('.carousel-prev');
                const nextButton = document.querySelector('.carousel-next');
                
                // No need to update button states initially for infinite loop
                // as all buttons are always enabled
                
                // Function to get number of slides visible based on screen width
                function getSlidesPerView() {
                    return 3; // Always show exactly 3 slides
                }
                
                // Function to go to a specific slide
                function goToSlide(index) {
                    // Calculate real index based on duplicated slides structure
                    let realIndex = index + featuredItems.length;
                    
                    // For infinite loop - handle end cases with special animation handling
                    const isWrappingStart = index < 0;
                    const isWrappingEnd = index >= featuredItems.length;
                    
                    if (isWrappingStart) {
                        // Stop the transition temporarily
                        carouselTrack.style.transition = "none";
                        realIndex = featuredItems.length * 2 - 1;
                        
                        // Apply the transform immediately
                        const slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                        const slideMargin = 20; // Updated margin-right value
                        const translateX = -(realIndex * (slideWidth + slideMargin));
                        carouselTrack.style.transform = `translate3d(${translateX}px, 0px, 0px)`;
                        
                        // Force a reflow
                        void carouselTrack.offsetWidth;
                        
                        // Re-enable the transition and go to the correct slide
                        setTimeout(() => {
                            carouselTrack.style.transition = "transform 0.5s ease-in-out";
                            goToSlide(featuredItems.length - 1);
                        }, 10);
                        
                        return;
                    }
                    
                    if (isWrappingEnd) {
                        // Stop the transition temporarily
                        carouselTrack.style.transition = "none";
                        realIndex = featuredItems.length;
                        
                        // Apply the transform immediately
                        const slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                        const slideMargin = 20; // Updated margin-right value
                        const translateX = -(realIndex * (slideWidth + slideMargin));
                        carouselTrack.style.transform = `translate3d(${translateX}px, 0px, 0px)`;
                        
                        // Force a reflow
                        void carouselTrack.offsetWidth;
                        
                        // Re-enable the transition and go to the correct slide
                        setTimeout(() => {
                            carouselTrack.style.transition = "transform 0.5s ease-in-out";
                            goToSlide(0);
                        }, 10);
                        
                        return;
                    }
                    
                    // Update current index
                    currentIndex = index;
                    
                    // Apply slide positions
                    const slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                    const slideMargin = 20; // Updated margin-right value
                    const translateX = -(realIndex * (slideWidth + slideMargin));
                    
                    console.log(`Moving to slide ${currentIndex}, translateX: ${translateX}px, realIndex: ${realIndex}`);
                    
                    // Apply smooth transition
                    carouselTrack.style.transition = "transform 0.5s ease-in-out";
                    carouselTrack.style.transform = `translate3d(${translateX}px, 0px, 0px)`;
                    
                    // Update active dot
                    if (carouselDots) {
                        const dots = carouselDots.querySelectorAll('.carousel-dot');
                        dots.forEach((dot, i) => {
                            dot.classList.toggle('active', i === currentIndex);
                        });
                    }
                    
                    // Update slide visibility and active classes
                    const slides = document.querySelectorAll('.carousel-slide');
                    slides.forEach((slide, i) => {
                        // Remove all special classes first
                        slide.classList.remove('swiper-slide-active', 'swiper-slide-next', 'swiper-slide-prev', 'swiper-slide-visible');
                        
                        // Add appropriate classes based on position
                        const slideIndex = parseInt(slide.dataset.swiperSlideIndex);
                        if (slideIndex === currentIndex) {
                            slide.classList.add('swiper-slide-active');
                            slide.classList.add('swiper-slide-visible');
                        } else if (slideIndex === (currentIndex + 1) % featuredItems.length) {
                            slide.classList.add('swiper-slide-next');
                            slide.classList.add('swiper-slide-visible');
                        } else if (slideIndex === (currentIndex - 1 + featuredItems.length) % featuredItems.length) {
                            slide.classList.add('swiper-slide-prev');
                            slide.classList.add('swiper-slide-visible');
                        }
                    });
                }
                
                // Initialize with first slide
                setTimeout(() => {
                    if (featuredItems && featuredItems.length > 0) {
                        const slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                        const slideMargin = 20; // Updated margin-right value
                        
                        // Calculate the initial position
                        const initialIndex = featuredItems.length;
                        const initialTranslateX = -(initialIndex * (slideWidth + slideMargin));
                        
                        carouselTrack.style.transition = "none";
                        carouselTrack.style.transform = `translate3d(${initialTranslateX}px, 0px, 0px)`;
                        
                        // Force a reflow
                        void carouselTrack.offsetWidth;
                        
                        // Update slide visibility and active classes for initial display
                        const slides = document.querySelectorAll('.carousel-slide');
                        slides.forEach((slide, i) => {
                            // Remove all special classes first
                            slide.classList.remove('swiper-slide-active', 'swiper-slide-next', 'swiper-slide-prev', 'swiper-slide-visible');
                            
                            // Add appropriate classes based on position
                            const slideIndex = parseInt(slide.dataset.swiperSlideIndex);
                            if (slideIndex === 0) {
                                slide.classList.add('swiper-slide-active');
                                slide.classList.add('swiper-slide-visible');
                            } else if (slideIndex === 1) {
                                slide.classList.add('swiper-slide-next');
                                slide.classList.add('swiper-slide-visible');
                            } else if (slideIndex === featuredItems.length - 1) {
                                slide.classList.add('swiper-slide-prev');
                                slide.classList.add('swiper-slide-visible');
                            }
                        });
                        
                        // Then enable transitions for future slides
                        setTimeout(() => {
                            carouselTrack.style.transition = "transform 0.5s ease-in-out";
                        }, 50);
                    }
                }, 100);
                
                // Add button event listeners
                prevButton.addEventListener('click', () => {
                    goToSlide(currentIndex - 1);
                });
                
                nextButton.addEventListener('click', () => {
                    goToSlide(currentIndex + 1);
                });
                
                // Add window resize handler
                window.addEventListener('resize', () => {
                    slideWidth = document.querySelector('.carousel-slide').getBoundingClientRect().width;
                    goToSlide(currentIndex);
                });
                
                // Start auto-scrolling
                let autoScrollInterval;
                
                function startAutoScroll() {
                    stopAutoScroll();
                    autoScrollInterval = setInterval(() => {
                        goToSlide(currentIndex + 1); // Will handle wrapping automatically
                    }, 5000); // Scroll every 5 seconds
                }
                
                function stopAutoScroll() {
                    if (autoScrollInterval) {
                        clearInterval(autoScrollInterval);
                    }
                }
                
                // Start auto-scrolling
                startAutoScroll();
                
                // Pause auto-scrolling when hovering over carousel
                const carouselSection = document.querySelector('.carousel-section');
                carouselSection.addEventListener('mouseenter', stopAutoScroll);
                carouselSection.addEventListener('mouseleave', startAutoScroll);
                
                return goToSlide;
            };
        }
        
        // Initialize carousel and store the update function
        const updateCarousel = initCarousel();
        
        // Modify loadMp3List to update carousel after loading items
        const originalLoadMp3List = loadMp3List;
        loadMp3List = function() {
            originalLoadMp3List.apply(this, arguments);
            
            // After mp3Items is populated, wait a bit for everything to process
            setTimeout(() => {
                if (mp3Items && mp3Items.length > 0) {
                    updateCarousel();
                }
            }, 1000);
        };
    </script>
</body>
</html>
