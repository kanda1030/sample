<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PK5TCDZ8');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3JQJ50606G"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-3JQJ50606G');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 データベース - アップロード・ダウンロード</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #171717;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #222;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        h1, h2, h3 {
            color: #eee;
            margin-top: 0;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .status-message.success {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .status-message.error {
            background-color: rgba(255, 102, 102, 0.2);
            color: #ff6666;
        }
        
        .upload-section, .download-section {
            background-color: #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .mp3-list {
            list-style-type: none;
            padding: 0;
        }
        
        .mp3-item {
            background-color: #444;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        button, .download-button {
            background-color: #215987;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover, .download-button:hover {
            background-color: #1a67b5;
        }
        
        input[type="file"], input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 4px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .file-info {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .db-status {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .thumbnail-preview {
            margin-top: 10px;
            max-width: 100%;
            height: 120px;
            background-color: #2a2a2a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .thumbnail-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .mp3-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .mp3-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            overflow: hidden;
            background-color: #333;
            flex-shrink: 0;
        }
        
        .mp3-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mp3-thumbnail.no-image {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #333, #444);
        }
        
        .mp3-thumbnail.no-image::before {
            content: '♪';
            font-size: 2em;
            color: #555;
        }
        
        .mp3-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .selected-files {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .selected-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #3a3a3a;
            border-radius: 4px;
        }
        
        .selected-file-item .file-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        
        .selected-file-item .file-size {
            color: #aaa;
            font-size: 0.8em;
        }
        
        .selected-file-item .remove-file {
            cursor: pointer;
            color: #ff6666;
            margin-left: 10px;
        }
        
        .selected-file-item .file-thumbnail-select {
            margin-left: 10px;
            background-color: #215987;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }
        
        .selected-file-item .file-thumbnail-select:hover {
            background-color: #1a67b5;
        }
        
        .thumbnail-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .thumbnail-item {
            position: relative;
            width: 80px;
            height: 80px;
            overflow: hidden;
            border-radius: 4px;
        }
        
        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .thumbnail-item .remove-thumbnail {
            position: absolute;
            top: 3px;
            right: 3px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .thumbnail-item .thumbnail-assigned {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 3px;
            font-size: 9px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .upload-progress {
            height: 5px;
            width: 100%;
            background-color: #333;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .dropzone {
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .dropzone.dragover {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .dropzone p {
            margin: 0;
            color: #ccc;
            font-size: 16px;
        }
        
        .dropzone.dragover p {
            color: #fff;
        }
        
        .mp3-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .mp3-meta-form {
            background-color: #555;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .mp3-meta-form.visible {
            display: block;
        }
        
        .mp3-meta-form input {
            margin-bottom: 10px;
        }
        
        .mp3-meta-form button {
            margin-right: 10px;
        }
        
        .sort-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background-color: #333;
            padding: 10px;
            border-radius: 4px;
        }
        
        .sort-controls select {
            width: auto;
            margin-bottom: 0;
            margin-left: 10px;
        }
        
        .sort-controls label {
            display: inline;
            margin-right: 5px;
        }
        
        .sort-group {
            display: flex;
            align-items: center;
        }
        
        .mp3-number {
            background-color: #215987;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .mp3-number:hover {
            background-color: #1a67b5;
        }
        
        /* クリック可能な要素のスタイル */
        .editable-text {
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable-text:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 編集中の要素 */
        .editing {
            background-color: #333;
            outline: 1px solid #4d90fe;
        }
        
        .edit-button, .number-button {
            background-color: #4a4a4a;
        }
        
        .edit-button:hover, .number-button:hover {
            background-color: #5a5a5a;
        }
        
        .sort-direction {
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .sort-direction:hover {
            background-color: #444;
        }
        
        .active-sort {
            font-weight: bold;
            color: #4CAF50;
        }
        
        /* タブのスタイル */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
        }
        
        .tab-button {
            background-color: transparent;
            color: #ccc;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            font-size: 16px;
        }
        
        .tab-button:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .tab-button.active {
            color: white;
            border-bottom: 2px solid #4d90fe;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Notionリストのスタイル */
        .notion-list {
            list-style-type: none;
            padding: 0;
        }
        
        .notion-item {
            background-color: #444;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .notion-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .notion-url {
            margin-bottom: 10px;
        }
        
        .notion-url a {
            color: #4d90fe;
            text-decoration: none;
        }
        
        .notion-url a:hover {
            text-decoration: underline;
        }
        
        .notion-description {
            color: #ccc;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .notion-mp3-title {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PK5TCDZ8"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div class="container">
        <h1>MP3 データベース</h1>
        
        <div id="db-status" class="db-status"></div>
        
        <a href="player.html" style="display: block; margin-bottom: 20px; color: #4c9ed9; text-decoration: none;">
            プレーヤー画面へ
        </a>
        
        <div class="upload-section">
            <h2>MP3をアップロード</h2>
            <div id="upload-status" class="status-message"></div>
            
            <!-- タブナビゲーション -->
            <div class="tabs">
                <button class="tab-button active" data-tab="mp3-upload-tab">MP3アップロード</button>
                <button class="tab-button" data-tab="notion-upload-tab">Notionリンク追加</button>
            </div>
            
            <form id="upload-form">
                <!-- MP3アップロードタブ -->
                <div id="mp3-upload-tab" class="tab-content active">
                    <div class="dropzone" id="mp3-dropzone">
                        <p>MP3ファイルをここにドラッグ&ドロップ</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="mp3File">MP3ファイル</label>
                        <input type="file" id="mp3File" accept=".mp3" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="thumbnailFile">サムネイル画像（オプション）</label>
                        <input type="file" id="thumbnailFile" accept="image/*" class="form-control">
                        <div id="thumbnailPreview" class="thumbnail-preview"></div>
                    </div>
                </div>
                
                <!-- Notionリンク追加タブ -->
                <div id="notion-upload-tab" class="tab-content">
                    <div class="form-group">
                        <label for="notionTitle">Notionページタイトル</label>
                        <input type="text" id="notionTitle" placeholder="関連するNotionページの名前" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="notionUrl">NotionページURL</label>
                        <input type="url" id="notionUrl" placeholder="https://www.notion.so/..." class="form-control">
                    </div>
                </div>
                
                <button type="submit" class="submit-button">アップロード</button>
            </form>
        </div>
        
        <div class="download-section">
            <h2>データベース内のMP3</h2>
            <div id="db-status" class="db-status">データベースに接続中...</div>
            
            <!-- タブナビゲーション -->
            <div class="tabs">
                <button class="tab-button active" data-tab="mp3-tab">MP3リスト</button>
                <button class="tab-button" data-tab="notion-tab">Notionリンク</button>
            </div>
            
            <!-- MP3タブコンテンツ -->
            <div id="mp3-tab" class="tab-content active">
                <div class="sort-controls">
                    <div class="sort-group">
                        <label for="sortBy">並び替え:</label>
                        <select id="sortBy">
                            <option value="number">番号順</option>
                            <option value="title">タイトル順</option>
                            <option value="date">登録日順</option>
                        </select>
                    </div>
                    <div class="sort-direction" id="sortDirection" data-direction="asc">
                        <span id="sortIcon">▲</span> <span id="sortText">昇順</span>
                    </div>
                </div>
                
                <ul id="mp3-list" class="mp3-list">
                    <!-- データベースからのMP3がここに表示されます -->
                </ul>
            </div>
            
            <!-- Notionタブコンテンツ -->
            <div id="notion-tab" class="tab-content">
                <ul id="notion-list" class="notion-list">
                    <!-- データベースからのNotionリンクがここに表示されます -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // IndexedDBの初期化
            let db;
            const dbName = 'mp3Database';
            const dbVersion = 3; // バージョンを3に更新
            const mp3List = document.getElementById('mp3-list');
            const dbStatus = document.getElementById('db-status');
            const sortBySelect = document.getElementById('sortBy');
            const sortDirection = document.getElementById('sortDirection');
            let sortBy = 'number'; // デフォルトの並び替え条件
            let isAscending = true; // 昇順/降順のフラグ

            // データベース接続
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = function(event) {
                console.error("データベースエラー:", event.target.error);
                dbStatus.textContent = "データベース接続エラー: " + event.target.error.message;
                dbStatus.className = "db-status error";
            };
            
            request.onblocked = function(event) {
                // これは他のタブでデータベースが開かれている場合に発生します
                console.warn("データベースの接続がブロックされています。他のタブを閉じてください。");
                dbStatus.textContent = "データベースの接続がブロックされています。他のタブを閉じてください。";
                dbStatus.className = "db-status error";
            };
            
            request.onupgradeneeded = function(event) {
                console.log("データベースのアップグレード中... 旧バージョン:", event.oldVersion, "新バージョン:", event.newVersion);
                const db = event.target.result;
                
                try {
                    // MP3を保存するオブジェクトストアの作成（もし存在しなければ）
                    if (!db.objectStoreNames.contains('mp3s')) {
                        console.log("mp3sオブジェクトストアを作成します");
                        const objectStore = db.createObjectStore('mp3s', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('title', 'title', { unique: false });
                        objectStore.createIndex('date', 'date', { unique: false });
                        objectStore.createIndex('number', 'number', { unique: false });
                        
                        // Notion関連のインデックスを追加
                        objectStore.createIndex('notionTitle', 'notionTitle', { unique: false });
                        objectStore.createIndex('notionUrl', 'notionUrl', { unique: false });
                        
                        console.log("mp3sオブジェクトストアの作成完了");
                    } else if (event.oldVersion < 2) {
                        // バージョン1から2へのアップグレード
                        console.log("既存のオブジェクトストアをアップグレードします");
                        const objectStore = event.target.transaction.objectStore('mp3s');
                        
                        // Notion関連のインデックスがなければ追加
                        if (!objectStore.indexNames.contains('notionTitle')) {
                            objectStore.createIndex('notionTitle', 'notionTitle', { unique: false });
                        }
                        if (!objectStore.indexNames.contains('notionUrl')) {
                            objectStore.createIndex('notionUrl', 'notionUrl', { unique: false });
                        }
                        
                        console.log("オブジェクトストアのアップグレード完了");
                    } else if (event.oldVersion < 3) {
                        // バージョン2から3へのアップグレード
                        console.log("バージョン2から3へのアップグレードを実行");
                        // 現在は特に追加のインデックスは作成しないが、将来的に必要があれば追加
                        console.log("バージョン3へのアップグレード完了");
                    }
                } catch (error) {
                    console.error("オブジェクトストア作成エラー:", error);
                    dbStatus.textContent = "データベース構造の作成に失敗しました: " + error.message;
                    dbStatus.className = "db-status error";
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                dbStatus.textContent = "データベース接続成功";
                dbStatus.className = "db-status success";
                
                // データベースバージョンを表示
                console.log("接続したデータベースのバージョン:", db.version);
                
                // 接続成功後もデータが見つからない場合に備えて、カウントを確認
                const transaction = db.transaction(['mp3s'], 'readonly');
                const objectStore = transaction.objectStore('mp3s');
                const countRequest = objectStore.count();
                
                countRequest.onsuccess = function() {
                    if (countRequest.result === 0) {
                        console.log("データベースは空です。");
                    } else {
                        console.log("データベースに " + countRequest.result + " 件のデータがあります。");
                    }
                };
                
                // DB接続のエラーハンドリング
                db.onerror = function(event) {
                    console.error("データベースエラー:", event.target.error);
                    dbStatus.textContent = "データベース操作エラー: " + event.target.error.message;
                    dbStatus.className = "db-status error";
                };
                
                // MP3リストを読み込み
                loadMp3List();
            };
            
            // 並び替え条件が変更された時のイベントリスナー
            sortBySelect.addEventListener('change', function() {
                sortBy = this.value;
                loadMp3List();
            });
            
            // 昇順/降順の切り替え
            sortDirection.addEventListener('click', function() {
                isAscending = !isAscending;
                this.dataset.direction = isAscending ? 'asc' : 'desc';
                document.getElementById('sortIcon').textContent = isAscending ? '▲' : '▼';
                document.getElementById('sortText').textContent = isAscending ? '昇順' : '降順';
                loadMp3List();
            });
            
            // タブ切り替え（Download Section）
            const tabButtons = document.querySelectorAll('.download-section .tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 現在のアクティブなタブを非アクティブにする
                    document.querySelector('.download-section .tab-button.active').classList.remove('active');
                    document.querySelector('.download-section .tab-content.active').classList.remove('active');
                    
                    // クリックされたタブをアクティブにする
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
            
            // タブ切り替え（Upload Section）
            const uploadTabButtons = document.querySelectorAll('.upload-section .tab-button');
            uploadTabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 現在のアクティブなタブを非アクティブにする
                    document.querySelector('.upload-section .tab-button.active').classList.remove('active');
                    document.querySelector('.upload-section .tab-content.active').classList.remove('active');
                    
                    // クリックされたタブをアクティブにする
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
            
            // MP3リストの読み込み
            function loadMp3List() {
                try {
                    if (!db) {
                        console.error("データベース接続が初期化されていません");
                        dbStatus.textContent = "データベース接続が初期化されていません。ページを再読み込みしてください。";
                        dbStatus.className = "db-status error";
                        return;
                    }

                    const transaction = db.transaction(['mp3s'], 'readonly');
                    const objectStore = transaction.objectStore('mp3s');
                    const request = objectStore.getAll();
                    
                    transaction.onerror = function(event) {
                        console.error("トランザクションエラー:", event.target.error);
                        dbStatus.textContent = "データ読み込みエラー: " + event.target.error.message;
                        dbStatus.className = "db-status error";
                    };
                    
                    request.onsuccess = function(event) {
                        const mp3Items = event.target.result;
                        console.log("データベースから " + mp3Items.length + " 件のデータを読み込みました");
                        
                        // 並び替え
                        mp3Items.sort((a, b) => {
                            let valueA, valueB;
                            
                            // 並び替えの条件に応じた値を取得
                            if (sortBy === 'number') {
                                valueA = a.number !== undefined ? a.number : Infinity;
                                valueB = b.number !== undefined ? b.number : Infinity;
                            } else if (sortBy === 'title') {
                                valueA = a.title || '';
                                valueB = b.title || '';
                            } else if (sortBy === 'date') {
                                valueA = a.date || 0;
                                valueB = b.date || 0;
                            }
                            
                            // 文字列の場合はlocaleCompareを使用
                            if (typeof valueA === 'string' && typeof valueB === 'string') {
                                return isAscending ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);
                            } 
                            
                            // 数値の場合は通常の比較
                            return isAscending ? valueA - valueB : valueB - valueA;
                        });
                        
                        // 実際のMP3アイテムとNotionアイテムを分離
                        const actualMp3Items = mp3Items.filter(item => {
                            // Notionデータのみを持つアイテムを除外（タイトルが "Notion:" で始まるアイテムも除外）
                            return !(
                                (item.title && item.title.startsWith('Notion:')) ||
                                (!item.data && (item.notionTitle || item.notionUrl))
                            );
                        });
                        
                        // MP3リストを表示（実際のMP3アイテムのみ）
                        displayMp3Items(actualMp3Items);
                        
                        // Notionリストも表示（全データから選別して表示）
                        displayNotionItems(mp3Items);
                    };
                    
                    request.onerror = function(event) {
                        console.error("MP3リスト読み込みエラー:", event.target.error);
                        dbStatus.textContent = "MP3データの読み込みに失敗しました: " + event.target.error.message;
                        dbStatus.className = "db-status error";
                    };
                } catch (error) {
                    console.error("データロード時に予期せぬエラーが発生しました:", error);
                    dbStatus.textContent = "データロード時に予期せぬエラーが発生しました: " + error.message;
                    dbStatus.className = "db-status error";
                }
            }
            
            // MP3アイテムの表示
            function displayMp3Items(items) {
                mp3List.innerHTML = '';
                
                if (items.length === 0) {
                    mp3List.innerHTML = '<li class="mp3-item" style="justify-content: center;">データベースにMP3はありません</li>';
                    return;
                }
                
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'mp3-item';
                    
                    // サムネイル画像
                    const thumbnailDiv = document.createElement('div');
                    thumbnailDiv.className = 'mp3-thumbnail';
                    
                    if (item.thumbnail) {
                        const imgBlob = new Blob([item.thumbnail], { type: item.thumbnailType || 'image/jpeg' });
                        const imgUrl = URL.createObjectURL(imgBlob);
                        
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.alt = item.title;
                        thumbnailDiv.appendChild(img);
                        
                        // ページを離れるときにURLを解放するためのイベントリスナー
                        window.addEventListener('beforeunload', function() {
                            URL.revokeObjectURL(imgUrl);
                        });
                    } else {
                        thumbnailDiv.classList.add('no-image');
                    }
                    
                    // MP3情報とコントロール部分
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'mp3-content';
                    
                    // タイトルと番号部分（インライン編集可能）
                    const titleContainer = document.createElement('div');
                    titleContainer.style.display = 'flex';
                    titleContainer.style.alignItems = 'center';
                    titleContainer.style.marginBottom = '10px';
                    
                    // 番号選択（常にプルダウンで表示）
                    const numberContainer = document.createElement('div');
                    numberContainer.className = 'mp3-number-container';
                    
                    // 番号選択のセレクトボックスを作成
                    const select = document.createElement('select');
                    select.style.backgroundColor = 'transparent';
                    select.style.color = 'white';
                    select.style.border = 'none';
                    select.style.borderRadius = '0';
                    select.style.padding = '3px';
                    select.style.marginRight = '10px';
                    select.style.appearance = 'none'; // デフォルトの矢印を非表示
                    select.style.webkitAppearance = 'none'; // Safari用
                    select.style.background = 'url("data:image/svg+xml;charset=utf8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'10\' viewBox=\'0 0 12 10\'%3E%3Cpath fill=\'%23ffffff\' d=\'M0,0l6,8l6-8\'/%3E%3C/svg%3E") no-repeat right 4px center/8px';
                    select.style.paddingRight = '16px';
                    
                    // カスタムセレクトボックスのスタイル設定
                    const customSelectCSS = document.createElement('style');
                    if (!document.querySelector('#custom-select-styles')) {
                        customSelectCSS.id = 'custom-select-styles';
                        customSelectCSS.textContent = `
                            select option {
                                background-color: #333;
                                color: white;
                            }
                            
                            select:focus {
                                outline: none;
                                box-shadow: 0 0 0 1px #4d90fe;
                            }
                        `;
                        document.head.appendChild(customSelectCSS);
                    }
                    
                    // 1-12までの番号オプション
                    for (let i = 1; i <= 12; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        if (item.number === i) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                    
                    // 値が変更されたら更新
                    select.addEventListener('change', function() {
                        const newNumber = parseInt(select.value);
                        
                        // 変更がある場合のみ更新
                        if (newNumber !== item.number) {
                            updateMP3(item.id, { number: newNumber });
                        }
                    });
                    
                    numberContainer.appendChild(select);
                    titleContainer.appendChild(numberContainer);
                    
                    // タイトル（クリックするとインラインで編集可能）
                    const titleSpan = document.createElement('div');
                    titleSpan.textContent = item.title || 'サンプルボーカル';
                    titleSpan.style.fontWeight = 'bold';
                    titleSpan.style.cursor = 'pointer';
                    titleSpan.style.flexGrow = '1';
                    titleSpan.style.padding = '5px';
                    titleSpan.title = 'クリックして番号を変更';
                    titleSpan.className = 'editable-title';
                    
                    // タイトルクリック時のイベント - インラインテキストボックスに変更
                    titleSpan.addEventListener('click', function(e) {
                        // すでに編集中なら何もしない
                        if (titleContainer.querySelector('input')) return;
                        
                        // テキスト要素を非表示
                        titleSpan.style.display = 'none';
                        
                        // 編集用のコンテナを作成
                        const editContainer = document.createElement('div');
                        editContainer.style.display = 'flex';
                        editContainer.style.alignItems = 'center';
                        editContainer.style.width = '100%';
                        
                        // 現在のタイトルから数字部分を抽出
                        const currentTitle = item.title || 'サンプルボーカル';
                        const numberMatch = currentTitle.match(/サンプルボーカル(\d*)/);
                        const currentNumber = numberMatch ? numberMatch[1] : '';
                        
                        // 固定部分のスパン作成
                        const fixedSpan = document.createElement('span');
                        fixedSpan.textContent = 'サンプルボーカル';
                        fixedSpan.style.fontWeight = 'bold';
                        fixedSpan.style.color = 'white';
                        
                        // インラインテキストボックスを作成（数字部分のみ）
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentNumber;
                        input.style.width = '60px';
                        input.style.padding = '5px';
                        input.style.border = 'none';
                        input.style.borderRadius = '0';
                        input.style.backgroundColor = 'transparent';
                        input.style.color = 'white';
                        input.style.fontWeight = 'bold';
                        
                        // 数字のみ入力可能にする
                        input.addEventListener('input', function() {
                            this.value = this.value.replace(/[^0-9]/g, '');
                        });
                        
                        // OKボタン
                        const okButton = document.createElement('button');
                        okButton.textContent = 'OK';
                        okButton.style.marginLeft = '5px';
                        okButton.style.padding = '2px 8px';
                        okButton.style.fontSize = '12px';
                        
                        // キャンセルボタン
                        const cancelButton = document.createElement('button');
                        cancelButton.textContent = 'キャンセル';
                        cancelButton.style.marginLeft = '5px';
                        cancelButton.style.padding = '2px 8px';
                        cancelButton.style.fontSize = '12px';
                        
                        // 編集を確定する関数
                        const confirmEdit = function() {
                            const numberPart = input.value.trim();
                            const newTitle = 'サンプルボーカル' + numberPart;
                            
                            // 変更がある場合のみ更新
                            if (newTitle !== currentTitle) {
                                updateMP3(item.id, { title: newTitle });
                            } else {
                                // 変更がなければ表示を元に戻すだけ
                                editContainer.remove();
                                titleSpan.style.display = '';
                            }
                        };
                        
                        // 編集をキャンセルする関数
                        const cancelEdit = function() {
                            editContainer.remove();
                            titleSpan.style.display = '';
                        };
                        
                        // OKボタンのクリックイベント
                        okButton.addEventListener('click', confirmEdit);
                        
                        // キャンセルボタンのクリックイベント
                        cancelButton.addEventListener('click', cancelEdit);
                        
                        // Enterキーで編集完了
                        input.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                confirmEdit();
                            } else if (e.key === 'Escape') {
                                cancelEdit();
                            }
                        });
                        
                        // コンテナに要素を追加
                        editContainer.appendChild(fixedSpan);
                        editContainer.appendChild(input);
                        editContainer.appendChild(okButton);
                        editContainer.appendChild(cancelButton);
                        
                        // 編集用コンテナを追加
                        titleContainer.appendChild(editContainer);
                        input.focus();
                        input.select();
                    });
                    
                    titleContainer.appendChild(titleSpan);
                    contentDiv.appendChild(titleContainer);
                    
                    // 詳細情報
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'file-info';
                    
                    const date = item.date ? new Date(item.date) : null;
                    if (date) {
                        detailsDiv.innerHTML += `登録日: ${formatDate(date)}<br>`;
                    }
                    
                    if (item.size) {
                        detailsDiv.innerHTML += `サイズ: ${formatFileSize(item.size)}`;
                    }
                    
                    contentDiv.appendChild(detailsDiv);
                    
                    // オーディオプレーヤー
                    const blob = new Blob([item.data], { type: 'audio/mpeg' });
                    const blobUrl = URL.createObjectURL(blob);
                    
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = blobUrl;
                    audio.style.width = '100%';
                    audio.style.marginTop = '10px';
                    
                    // ページを離れるときにURLを解放するためのイベントリスナー
                    window.addEventListener('beforeunload', function() {
                        URL.revokeObjectURL(blobUrl);
                    });
                    
                    // アクションボタン
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'mp3-actions';
                    
                    // 削除ボタン
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '削除';
                    deleteBtn.className = 'delete-button';
                    deleteBtn.onclick = function() {
                        if (confirm(`「${item.title || 'サンプルボーカル'}」を削除してもよろしいですか？`)) {
                            deleteMp3(item.id);
                        }
                    };
                    actionsDiv.appendChild(deleteBtn);
                    
                    contentDiv.appendChild(actionsDiv);
                    contentDiv.appendChild(audio);
                    
                    li.appendChild(thumbnailDiv);
                    li.appendChild(contentDiv);
                    
                    mp3List.appendChild(li);
                });
            }
            
            // Notionアイテムの表示
            function displayNotionItems(items) {
                const notionList = document.getElementById('notion-list');
                notionList.innerHTML = '';
                
                // Notionデータがあるアイテムのみをフィルタリング
                const notionItems = items.filter(item => {
                    return item.notionTitle || item.notionUrl || (item.title && item.title.startsWith('Notion:'));
                });
                
                if (notionItems.length === 0) {
                    notionList.innerHTML = '<li class="notion-item" style="justify-content: center;">Notionリンクはありません</li>';
                    return;
                }
                
                notionItems.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'notion-item';
                    
                    // Notionタイトル - 通常のnotionTitleか、タイトルがNotion:で始まる場合
                    let displayTitle = '';
                    if (item.notionTitle) {
                        displayTitle = item.notionTitle;
                    } else if (item.title && item.title.startsWith('Notion:')) {
                        displayTitle = item.title.replace('Notion: ', '');
                    }
                    
                    if (displayTitle) {
                        const notionTitle = document.createElement('div');
                        notionTitle.className = 'notion-title';
                        notionTitle.textContent = displayTitle;
                        li.appendChild(notionTitle);
                    }
                    
                    // NotionURL
                    if (item.notionUrl) {
                        const notionUrl = document.createElement('div');
                        notionUrl.className = 'notion-url';
                        
                        const link = document.createElement('a');
                        link.href = item.notionUrl;
                        link.target = '_blank';
                        link.textContent = '開く';
                        notionUrl.appendChild(link);
                        li.appendChild(notionUrl);
                    }
                    
                    // 関連MP3タイトル - タイトルがNotion:で始まらない場合のみ表示
                    if (!item.title || !item.title.startsWith('Notion:')) {
                        const mp3Title = document.createElement('div');
                        mp3Title.className = 'notion-mp3-title';
                        mp3Title.textContent = `MP3: ${item.title || `#${item.id}`}`;
                        li.appendChild(mp3Title);
                    }
                    
                    // 削除ボタン
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'notion-actions';
                    actionsDiv.style.marginTop = '10px';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '削除';
                    deleteBtn.className = 'delete-button';
                    deleteBtn.style.backgroundColor = '#d32f2f';
                    deleteBtn.onclick = function() {
                        const confirmMessage = displayTitle 
                            ? `「${displayTitle}」を削除してもよろしいですか？` 
                            : 'このNotionリンクを削除してもよろしいですか？';
                        if (confirm(confirmMessage)) {
                            deleteMp3(item.id);
                        }
                    };
                    actionsDiv.appendChild(deleteBtn);
                    li.appendChild(actionsDiv);
                    
                    notionList.appendChild(li);
                });
            }
            
            // MP3情報の更新
            function updateMP3(id, updates) {
                const transaction = db.transaction(['mp3s'], 'readwrite');
                const objectStore = transaction.objectStore('mp3s');
                
                // まず該当するアイテムを取得
                const getRequest = objectStore.get(id);
                
                getRequest.onsuccess = function(event) {
                    const item = event.target.result;
                    
                    // アイテムの更新
                    for (const key in updates) {
                        item[key] = updates[key];
                    }
                    
                    // 更新したアイテムを保存
                    const updateRequest = objectStore.put(item);
                    
                    updateRequest.onsuccess = function() {
                        // 成功したらリストを再読み込み
                        loadMp3List();
                    };
                    
                    updateRequest.onerror = function(event) {
                        console.error("更新エラー:", event.target.error);
                        alert("MP3の更新に失敗しました。");
                    };
                };
            }
            
            // MP3の削除
            function deleteMp3(id) {
                const transaction = db.transaction(['mp3s'], 'readwrite');
                const objectStore = transaction.objectStore('mp3s');
                const request = objectStore.delete(id);
                
                request.onsuccess = function() {
                    loadMp3List();
                };
                
                request.onerror = function(event) {
                    console.error("削除エラー:", event.target.error);
                    alert("MP3の削除に失敗しました。");
                };
            }
            
            // ファイルアップロードフォームの処理
            document.getElementById('upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const mp3File = document.getElementById('mp3File').files[0];
                const thumbnailFile = document.getElementById('thumbnailFile').files[0];
                const notionTitle = document.getElementById('notionTitle').value.trim();
                const notionUrl = document.getElementById('notionUrl').value.trim();
                
                // アクティブなタブを確認
                const activeTab = document.querySelector('.upload-section .tab-button.active').dataset.tab;
                
                if (activeTab === 'mp3-upload-tab') {
                    // MP3アップロードタブがアクティブ
                    if (!mp3File) {
                        alert('MP3ファイルを選択してください');
                        return;
                    }
                    
                    // ローディングを表示
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード中...';
                    uploadButton.disabled = true;
                    
                    // MP3ファイルを読み込み
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const mp3Data = event.target.result;
                        const autoTitle = mp3File.name.replace('.mp3', ''); // ファイル名をタイトルとして使用
                        
                        // サムネイル画像がある場合は読み込み
                        if (thumbnailFile) {
                            const thumbnailReader = new FileReader();
                            thumbnailReader.onload = function(event) {
                                const thumbnailData = event.target.result;
                                saveMp3WithThumbnailToDatabase(mp3Data, autoTitle, thumbnailData, thumbnailFile.type, null, null);
                            };
                            thumbnailReader.readAsArrayBuffer(thumbnailFile);
                        } else {
                            // サムネイルなしでMP3を保存
                            saveMp3WithThumbnailToDatabase(mp3Data, autoTitle, null, null, null, null);
                        }
                    };
                    
                    reader.readAsArrayBuffer(mp3File);
                } else {
                    // Notionリンク追加タブがアクティブ
                    if (!notionTitle) {
                        alert('Notionタイトルを入力してください');
                        return;
                    }
                    
                    if (!notionUrl) {
                        alert('NotionのURLを入力してください');
                        return;
                    }
                    
                    // URLの簡易検証
                    if (!notionUrl.startsWith('http://') && !notionUrl.startsWith('https://')) {
                        alert('有効なNotionのURLを入力してください');
                        return;
                    }
                    
                    // ローディングを表示
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード中...';
                    uploadButton.disabled = true;
                    
                    // Notionデータのみをデータベースに保存
                    saveNotionToDatabase(notionTitle, notionUrl);
                }
            });
            
            // MP3とサムネイルをデータベースに保存
            function saveMp3WithThumbnailToDatabase(mp3Data, title, thumbnailData, thumbnailType, notionTitle, notionUrl) {
                const transaction = db.transaction(['mp3s'], 'readwrite');
                const store = transaction.objectStore('mp3s');
                
                const mp3Item = {
                    title: title,
                    data: mp3Data,
                    date: new Date().toISOString(),
                    size: mp3Data.byteLength,
                    notionTitle: notionTitle || null,
                    notionUrl: notionUrl || null
                };
                
                // サムネイルがある場合は追加
                if (thumbnailData) {
                    mp3Item.thumbnail = thumbnailData;
                    mp3Item.thumbnailType = thumbnailType;
                }
                
                const request = store.add(mp3Item);
                
                request.onsuccess = function() {
                    console.log('MP3が保存されました');
                    
                    // フォームをリセット
                    document.getElementById('mp3File').value = '';
                    document.getElementById('thumbnailFile').value = '';
                    document.getElementById('thumbnailPreview').innerHTML = '';
                    document.getElementById('notionTitle').value = '';
                    document.getElementById('notionUrl').value = '';
                    
                    // ボタンを元に戻す
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード';
                    uploadButton.disabled = false;
                    
                    // MP3リストを更新
                    loadMp3List();
                };
                
                request.onerror = function(event) {
                    console.error("保存エラー:", event.target.error);
                    alert('MP3の保存中にエラーが発生しました');
                    
                    // ボタンを元に戻す
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード';
                    uploadButton.disabled = false;
                };
            }
            
            // Notionデータのみをデータベースに保存
            function saveNotionToDatabase(notionTitle, notionUrl) {
                const transaction = db.transaction(['mp3s'], 'readwrite');
                const store = transaction.objectStore('mp3s');
                
                const notionItem = {
                    title: 'Notion: ' + notionTitle, // タイトルに「Notion:」プレフィックスを追加
                    date: new Date().toISOString(),
                    notionTitle: notionTitle,
                    notionUrl: notionUrl
                };
                
                const request = store.add(notionItem);
                
                request.onsuccess = function() {
                    console.log('Notionリンクが保存されました');
                    
                    // フォームをリセット
                    document.getElementById('notionTitle').value = '';
                    document.getElementById('notionUrl').value = '';
                    
                    // ボタンを元に戻す
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード';
                    uploadButton.disabled = false;
                    
                    // MP3リストを更新
                    loadMp3List();
                };
                
                request.onerror = function(event) {
                    console.error("保存エラー:", event.target.error);
                    alert('Notionリンクの保存中にエラーが発生しました');
                    
                    // ボタンを元に戻す
                    const uploadButton = document.querySelector('.submit-button');
                    uploadButton.textContent = 'アップロード';
                    uploadButton.disabled = false;
                };
            }
            
            // サムネイルプレビュー
            document.getElementById('thumbnailFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('画像ファイルを選択してください。');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewContainer = document.getElementById('thumbnailPreview');
                    previewContainer.innerHTML = '';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewContainer.appendChild(img);
                };
                
                reader.readAsDataURL(file);
            });
            
            // ファイルサイズをフォーマット
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            // 日付フォーマット関数
            function formatDate(dateInput) {
                if (!dateInput) return '不明';
                
                let date;
                // 文字列の場合はDateオブジェクトに変換
                if (typeof dateInput === 'string') {
                    date = new Date(dateInput);
                }
                // 数値の場合はタイムスタンプとして扱う
                else if (typeof dateInput === 'number') {
                    date = new Date(dateInput);
                }
                // すでにDateオブジェクトの場合はそのまま使用
                else if (dateInput instanceof Date) {
                    date = dateInput;
                }
                else {
                    return '不明';
                }
                
                // 日付が不正な場合
                if (isNaN(date.getTime())) {
                    return '不明';
                }
                
                // ロケールに応じた日付フォーマットを使用
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                
                return date.toLocaleDateString('ja-JP', options).replace(/\//g, '-');
            }
            
            // プレイヤーページへのリンク
            document.getElementById('to-player').addEventListener('click', function() {
                window.location.href = 'player.html';
            });
        });
    </script>
</body>
</html> 
